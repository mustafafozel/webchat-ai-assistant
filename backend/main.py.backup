import os
import logging
import random
import re
from datetime import datetime
from typing import Dict, Any, List
import httpx
import requests

from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import HTMLResponse
from pydantic import BaseModel

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

app = FastAPI(title="WebChat AI Assistant")

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Environment
GROQ_API_KEY = os.getenv("GROQ_API_KEY", "")
logger.info(f"ğŸ”‘ GROQ_API_KEY: {GROQ_API_KEY[:20]}..." if GROQ_API_KEY else "âŒ GROQ_API_KEY not found")

# Ollama check - more comprehensive
def check_ollama():
    ollama_urls = [
        "http://ollama:11434"
    ]
    
    for url in ollama_urls:
        try:
            resp = requests.get(f"{url}/api/version", timeout=2)
            if resp.status_code == 200:
                data = resp.json()
                logger.info(f"âœ… Ollama found: {url} (v{data.get('version', 'unknown')})")
                return url
        except Exception:
            continue
    
    logger.info("âŒ Ollama not accessible from container")
    return None

ollama_base_url = check_ollama()
ollama_available = bool(ollama_base_url)

# Provider selection
groq_available = bool(GROQ_API_KEY and GROQ_API_KEY.startswith("gsk_"))

if groq_available:
    ai_provider = "groq"
elif ollama_available:
    ai_provider = "ollama"
else:
    ai_provider = "smart_fallback"

logger.info(f"ğŸ¤– AI Provider: {ai_provider}")

# Models
class ChatMessage(BaseModel):
    message: str
    session_id: str = "default"

class ChatResponse(BaseModel):
    response: str
    session_id: str
    metadata: Dict[str, Any] = {}

# Memory
session_memory: Dict[str, List[Dict]] = {}

# Enhanced tools
def get_order_status(order_id: str) -> str:
    orders = {
        "12345": """âœ… **SÄ°PARÄ°Å DURUMU - KARGODA**

ğŸ“‹ SipariÅŸ No: 12345
ğŸ¯ Durum: Teslimat Yolunda ğŸšš
ğŸ“¦ Kargo: Aras Kargo
ğŸ”— Takip: TK789456123

ğŸ“ **GÃ¼ncel Konum:**
Ä°stanbul DaÄŸÄ±tÄ±m Merkezi
Son gÃ¼ncelleme: 31 Ekim 21:45

â° **Tahmini Teslimat:**
1 KasÄ±m Cumartesi
Saat aralÄ±ÄŸÄ±: 09:00 - 18:00

ğŸ“± **Bilgilendirme:**
â€¢ Teslimat Ã¶ncesi SMS gelecek
â€¢ Evde yoksa komÅŸuya bÄ±rakÄ±labilir
â€¢ Acil durum: 444 0 123""",

        "67890": """ğŸ“¦ **SÄ°PARÄ°Å HAZIRLIK AÅAMASI**

ğŸ“‹ SipariÅŸ No: 67890
ğŸ”„ Durum: Paketleme TamamlandÄ± âœ…
ğŸ“ Konum: Ana Depo - Ä°stanbul

â° **Kargo ProgramÄ±:**
Kargoya verme: YarÄ±n 09:00
Takip kodu: YarÄ±n SMS ile gelecek
Tahmini teslimat: 2-3 gÃ¼n

ğŸ“ **Ä°letiÅŸim:**
Soru/Sorun: 444 0 123
Email: siparis@example.com""",

        "11111": """ğŸ‰ **SÄ°PARÄ°Å TESLÄ°M EDÄ°LDÄ°**

ğŸ“‹ SipariÅŸ No: 11111
âœ… Durum: BaÅŸarÄ±yla Teslim Edildi
ğŸ“… Teslimat: 31 Ekim 2025, 15:30
ğŸ‘¤ Teslim Alan: MÃ¼ÅŸteri (Ä°mzalÄ±)
ğŸ“ Adres: KayÄ±tlÄ± ev adresi

ğŸ **TeÅŸekkÃ¼rler!**
â­ Deneyiminizi deÄŸerlendirin
ğŸ¯ 5 yÄ±ldÄ±z = Ã¶zel indirim kuponu
ğŸ“§ DeÄŸerlendirme linki SMS'le geldi""",

        "22222": """âš ï¸ **SÄ°PARÄ°Å BEKLEMEDE**

ğŸ“‹ SipariÅŸ No: 22222
â— Durum: ÃœrÃ¼n Stok KontrolÃ¼
ğŸ” SÃ¼reÃ§: TedarikÃ§i ile koordinasyon

â° **Tahmini SÃ¼reÃ§:**
Stok kontrolÃ¼: 1-2 gÃ¼n
GÃ¼ncellemeler: SMS ile bilgilendirme
MÃ¼ÅŸteri hizmetleri arayacak: BugÃ¼n

ğŸ’¡ **SeÃ§enekleriniz:**
1. Stok gelince bekle (Ã¶ncelik size)
2. Benzer Ã¼rÃ¼n Ã¶nerisi al
3. SipariÅŸ iptali - anÄ±nda para iadesi

ğŸ“ **Direkt Ä°letiÅŸim:** 444 0 123""",

        "33333": """âŒ **SÄ°PARÄ°Å SORUNLU**

ğŸ“‹ SipariÅŸ No: 33333
âš ï¸ Durum: Teslimat Sorunu
ğŸ“ Problem: Adres bulunamadÄ±

ğŸ”§ **Ã‡Ã¶zÃ¼m SÃ¼reci:**
Kargo firmasÄ± tekrar deneyecek
Adres doÄŸrulama gerekli
MÃ¼ÅŸteri hizmetleri arayacak

ğŸ“ **Acil Ã‡Ã¶zÃ¼m:**
Telefon: 444 0 123 (7/24)
Whatsapp: +90 555 123 45 67
Online adres gÃ¼ncelleme mevcut"""
    }
    
    return orders.get(order_id, f"""âŒ **SÄ°PARÄ°Å BULUNAMADI**

ğŸ” **Aranan Numara:** {order_id}
â— **Durum:** Bu sipariÅŸ numarasÄ± sistemimizde kayÄ±tlÄ± deÄŸil

âœ… **Kontrol Listesi:**
â€¢ SipariÅŸ numarasÄ±nÄ± doÄŸru yazdÄ±ÄŸÄ±nÄ±zdan emin olun
â€¢ Email kutunuzdaki onay mailini kontrol edin
â€¢ SMS'inizdeki sipariÅŸ bilgilerini kontrol edin
â€¢ Son 6 ay iÃ§indeki sipariÅŸler sorgulanabilir

ğŸ“ **HÄ±zlÄ± Ã‡Ã¶zÃ¼m:**
â€¢ Ana hat: 444 0 123 (7/24 destek)
â€¢ Whatsapp: +90 555 123 45 67  
â€¢ Email: siparis@example.com
â€¢ CanlÄ± destek: Website chat

ğŸ’¡ **Ä°pucu:** Email adresinizle de sorgulama yapabilirsiniz""")

def calculate_shipping(city: str, weight: float = 1.0) -> str:
    city_data = {
        "istanbul": {"rate": 15, "zone": "A", "days": "1-2", "same_day": True},
        "ankara": {"rate": 18, "zone": "A", "days": "1-2", "same_day": True},
        "izmir": {"rate": 20, "zone": "A", "days": "2-3", "same_day": True},
        "antalya": {"rate": 25, "zone": "B", "days": "2-3", "same_day": False},
        "bursa": {"rate": 22, "zone": "B", "days": "2-3", "same_day": False},
        "adana": {"rate": 28, "zone": "C", "days": "3-4", "same_day": False},
        "gaziantep": {"rate": 30, "zone": "C", "days": "3-4", "same_day": False},
        "trabzon": {"rate": 32, "zone": "D", "days": "4-5", "same_day": False}
    }
    
    info = city_data.get(city.lower(), {"rate": 35, "zone": "D", "days": "4-6", "same_day": False})
    
    base_cost = info["rate"]
    weight_cost = max(0, (weight - 1) * 3)  # Ä°lk 1kg dahil
    standard_cost = base_cost + weight_cost
    express_cost = standard_cost + 15
    
    result = f"""ğŸšš **KARGO HESAPLAMASÄ± - {city.upper()}**

ğŸ“ **Hedef Bilgileri:**
â€¢ Åehir: {city.title()} ({info["zone"]} BÃ¶lgesi)  
â€¢ Paket aÄŸÄ±rlÄ±ÄŸÄ±: {weight} kg
â€¢ Temel Ã¼cret: {base_cost} TL + {weight_cost} TL (aÄŸÄ±rlÄ±k)

ğŸ’° **Kargo SeÃ§enekleri:**

ğŸš› **Standart Kargo: {standard_cost} TL**
â€¢ â° Teslimat sÃ¼resi: {info["days"]} iÅŸ gÃ¼nÃ¼
â€¢ ğŸ“± Takip: SMS + Online takip sistemi
â€¢ ğŸ“§ Email bildirimleri otomatik

âš¡ **Express Kargo: {express_cost} TL**
â€¢ â° Teslimat sÃ¼resi: 1 gÃ¼n hÄ±zlandÄ±rma  
â€¢ ğŸ“± Takip: SMS + Whatsapp + Push bildirimi
â€¢ ğŸ”” CanlÄ± konum takibi"""

    if info["same_day"]:
        same_day_cost = standard_cost + 25
        result += f"""

ğŸƒ **AynÄ± GÃ¼n Teslimat: {same_day_cost} TL**
â€¢ â° Teslimat sÃ¼resi: 3-6 saat iÃ§inde
â€¢ ğŸ“± CanlÄ± konum takibi aktif
â€¢ âš ï¸ SÄ±nÄ±r: 14:00'a kadar verilen sipariÅŸler
â€¢ ğŸ“ Kurye ile direkt iletiÅŸim"""

    result += f"""

ğŸ **Kampanya & Ä°ndirimler:**
â€¢ ğŸ†“ 150 TL+ alÄ±ÅŸveriÅŸlerde standart kargo Ã¼cretsiz
â€¢ ğŸ†“ 300 TL+ alÄ±ÅŸveriÅŸlerde express kargo Ã¼cretsiz
â€¢ ğŸ‘‘ Premium Ã¼yelerde tÃ¼m kargolar Ã¼cretsiz
â€¢ ğŸ‰ Ä°lk sipariÅŸte %50 kargo indirimi
â€¢ ğŸ“ Kargo noktasÄ±na teslimat: 5 TL indirim

ğŸ“ **Kargo Destek:** 444 0 126 (7/24)"""

    return result

def get_policy_info(topic: str) -> str:
    policies = {
        "iade": """ğŸ“‹ **Ä°ADE POLÄ°TÄ°KASI - DETAYLI**

âœ… **Ä°ade SÃ¼resi:** 14 gÃ¼n (yasal hak - fatura tarihinden itibaren)

ğŸ“¦ **Ä°ade Edilebilir ÃœrÃ¼nler:**
â€¢ Elektronik Ã¼rÃ¼nler (kutusunda, hasarsÄ±z, aksesuarlarÄ± tam)
â€¢ Giyim eÅŸyalarÄ± (etiketli, denenmemiÅŸ, temiz)
â€¢ Ev eÅŸyalarÄ± (ambalajÄ±nda, kullanÄ±lmamÄ±ÅŸ)
â€¢ Kitap ve medya Ã¼rÃ¼nleri
â€¢ Kozmetik Ã¼rÃ¼nler (aÃ§Ä±lmamÄ±ÅŸ, mÃ¼hÃ¼rlÃ¼)

âŒ **Ä°ade Edilemeyenler:**
â€¢ Hijyen Ã¼rÃ¼nleri (aÃ§Ä±lmÄ±ÅŸ olanlar)
â€¢ Ä°Ã§ giyim eÅŸyalarÄ± (denenmiÅŸ)
â€¢ Ã–zel Ã¼retim/kiÅŸiselleÅŸtirilmiÅŸ Ã¼rÃ¼nler
â€¢ GÄ±da maddeleri (bozulabilir)
â€¢ YazÄ±lÄ±m ve dijital Ã¼rÃ¼nler (kullanÄ±lmÄ±ÅŸ)

ğŸ”„ **Ä°ade SÃ¼reci (5 Kolay AdÄ±m):**
1. **Online Ä°ade Talebi:** Website'den "Ä°adelerim" bÃ¶lÃ¼mÃ¼nden talep oluÅŸtur
2. **Onay & Kod:** Email ile iade kodu ve Ã¼cretsiz kargo etiketi al (30 dk iÃ§inde)
3. **Paketleme:** ÃœrÃ¼nÃ¼ orijinal kutusuyla, aksesuarlarÄ±yla birlikte hazÄ±rla
4. **Kargo:** Ãœcretsiz iade etiketini yapÄ±ÅŸtÄ±r, kargoya ver
5. **Ä°nceleme & Ä°ade:** 2-3 iÅŸ gÃ¼nÃ¼ inceleme, onay sonrasÄ± para iadesi

ğŸ’³ **Para Ä°adesi SÃ¼releri:**
â€¢ **Kredi KartÄ±:** 2-5 iÅŸ gÃ¼nÃ¼ (otomatik)
â€¢ **Banka KartÄ±:** 1-3 iÅŸ gÃ¼nÃ¼
â€¢ **KapÄ±da Ã–deme:** Banka havalesi 1 iÅŸ gÃ¼nÃ¼
â€¢ **Hediye KartÄ±:** AnÄ±nda bakiye yÃ¼kleme

ğŸ“ **Ä°ade Destek HattÄ±:** 444 0 125 (Hafta iÃ§i 08:00-22:00)""",

        "kargo": """ğŸšš **KARGO & TESLÄ°MAT REHBERÄ°**

ğŸ—ºï¸ **TÃ¼rkiye Geneli Teslimat BÃ¶lgeleri:**

ğŸ…°ï¸ **A BÃ¶lgesi (1-2 gÃ¼n):** Ä°stanbul, Ankara, Ä°zmir
ğŸ…±ï¸ **B BÃ¶lgesi (2-3 gÃ¼n):** Antalya, Bursa, Konya, Kayseri  
ğŸ…² **C BÃ¶lgesi (3-4 gÃ¼n):** Adana, Samsun, Trabzon, Gaziantep
ğŸ…³ **D BÃ¶lgesi (4-5 gÃ¼n):** DoÄŸu/GÃ¼neydoÄŸu Anadolu illeri

ğŸ’° **Kargo Ãœcret Tablosu:**
â€¢ A BÃ¶lgesi: 15-20 TL â€¢ B BÃ¶lgesi: 22-28 TL
â€¢ C BÃ¶lgesi: 28-32 TL â€¢ D BÃ¶lgesi: 32-40 TL
â€¢ AÄŸÄ±rlÄ±k: Ä°lk 1 kg dahil, sonrasÄ± her kg +3 TL

âš¡ **HÄ±zlÄ± Teslimat SeÃ§enekleri:**
â€¢ **Express Kargo:** +15 TL (1 gÃ¼n hÄ±zlandÄ±rma)  
â€¢ **AynÄ± GÃ¼n Teslimat:** +25 TL (seÃ§ili ÅŸehirler, 14:00'a kadar)
â€¢ **Sabah Teslimat:** +10 TL (09:00-12:00 arasÄ±)

ğŸ **Ãœcretsiz Kargo KampanyalarÄ±:**
â€¢ 150 TL+ alÄ±ÅŸveriÅŸ: Standart kargo Ã¼cretsiz
â€¢ 300 TL+ alÄ±ÅŸveriÅŸ: Express kargo Ã¼cretsiz
â€¢ Premium Ã¼yelik: TÃ¼m kargolar her zaman Ã¼cretsiz
â€¢ Ä°lk sipariÅŸte %50 kargo indirimi

ğŸ  **Teslimat SeÃ§enekleri:**
â€¢ **Ev/Ä°ÅŸ Adresi:** KapÄ±ya kadar teslimat (standart)
â€¢ **Kargo NoktasÄ±:** 1500+ nokta, 5 TL indirim
â€¢ **KomÅŸu Teslimat:** GÃ¼venli alternatif adres
â€¢ **Otomat Teslim:** SeÃ§ili lokasyonlarda 24/7

ğŸ“± **Takip & Bildirim Sistemi:**
â€¢ SMS ile kargo takip kodu (otomatik)
â€¢ Online canlÄ± takip sistemi
â€¢ Whatsapp bot ile kolay takip
â€¢ Email bildirimleri (isteÄŸe baÄŸlÄ±)
â€¢ Mobil uygulama push bildirimleri
â€¢ Teslimat Ã¶ncesi kesin saat bildirimi

ğŸ“ **Kargo Destek:** 444 0 126 (7/24 destek hattÄ±)""",

        "Ã¶deme": """ğŸ’³ **Ã–DEME YÃ–NTEMLERÄ° & GÃœVENLÄ°K**

ğŸ¦ **Kabul Edilen Kartlar:**
â€¢ **Kredi KartlarÄ±:** Visa, Mastercard, American Express
â€¢ **Banka KartlarÄ±:** TÃ¼m TÃ¼rk bankalarÄ±nÄ±n kartlarÄ±
â€¢ **Sanal Kartlar:** Ä°nternetbank sanal kartlarÄ±
â€¢ **YabancÄ± Kartlar:** 3D Secure ile gÃ¼venli Ã¶deme
â€¢ **Ã–n Ã–demeli Kartlar:** Maximum, Paraf vb.

ğŸ“± **Dijital CÃ¼zdanlar:**
â€¢ **Apple Pay** (iPhone/iPad/Mac/Apple Watch)
â€¢ **Google Pay** (Android cihazlar)
â€¢ **Samsung Pay** (Galaxy serisi)
â€¢ **Garanti Pay, Akbank Mobil, Ä°ÅŸ Cep**

ğŸ’¸ **Alternatif Ã–deme YÃ¶ntemleri:**
â€¢ **KapÄ±da Ã–deme:** Nakit/Kart (+5 TL hizmet bedeli)
â€¢ **Havale/EFT:** %3 indirim avantajÄ± (hesap no otomatik)
â€¢ **Hediye KartlarÄ±:** Sodexo, Multinet, SetCard, Ticket
â€¢ **Kurumsal AnlaÅŸmalar:** Ã–zel Ã¶deme koÅŸullarÄ±

ğŸ“Š **Taksit Ä°mkanlarÄ± & Kampanyalar:**

ğŸ¦ **Banka Ã–zel KampanyalarÄ±:**
â€¢ **Garanti BankasÄ±:** 12 aya kadar 0% faiz
â€¢ **Ä°ÅŸ BankasÄ±:** 9 aya kadar 0% faiz + bonus
â€¢ **Akbank:** 6 aya kadar 0% faiz + axess puan  
â€¢ **YapÄ± Kredi:** DÃ¼nya kart ile Ã¶zel indirimler
â€¢ **QNB Finansbank:** 3 ay 0% faiz + mil kazanÄ±mÄ±

ğŸ’° **Minimum/Maksimum Limitler:**
â€¢ Kredi kartÄ±: 50 TL - 50.000 TL
â€¢ KapÄ±da Ã¶deme: 100 TL - 2.000 TL
â€¢ Havale/EFT: Limit yok
â€¢ Hediye kartÄ±: 25 TL - kart limiti kadar

ğŸ›¡ï¸ **GÃ¼venlik & Koruma:**
â€¢ **256-bit SSL ÅŸifreleme** (bankacÄ±lÄ±k dÃ¼zeyinde)
â€¢ **3D Secure** zorunlu doÄŸrulama (SMS/token)
â€¢ **PCI DSS uyumlu** sistem sertifikasÄ±
â€¢ **Anti-fraud** koruma sistemi 7/24 aktif
â€¢ **Ä°ki faktÃ¶rlÃ¼ gÃ¼venlik** (2FA) desteÄŸi
â€¢ **GÃ¼venli Ã¶deme garantisi** (MasterCard/Visa)

ğŸ“ **Ã–deme Destek:** 444 0 127 (7/24 teknik destek)""",

        "garanti": """ğŸ›¡ï¸ **GARANTÄ° & SERVÄ°S HÄ°ZMETLERÄ°**

âš¡ **Elektronik ÃœrÃ¼n Garantileri:**
â€¢ **Telefon/Tablet:** 2 yÄ±l resmi distribÃ¼tÃ¶r garantisi
â€¢ **Bilgisayar/Laptop:** 2 yÄ±l + 3 yÄ±l uzatma seÃ§eneÄŸi
â€¢ **Beyaz EÅŸya:** 2-3 yÄ±l (markaya gÃ¶re) + 10 yÄ±l yedek parÃ§a
â€¢ **TV/Ses Sistemi:** 2 yÄ±l panel + 5 yÄ±l yedek parÃ§a garantisi
â€¢ **KÃ¼Ã§Ã¼k Ev Aletleri:** 1-2 yÄ±l (markaya gÃ¶re deÄŸiÅŸir)
â€¢ **Oyun Konsolu:** 1 yÄ±l + geniÅŸletilmiÅŸ garanti seÃ§eneÄŸi

ğŸ‘• **Tekstil & Giyim Garantileri:**
â€¢ **DeÄŸiÅŸim Garantisi:** 30 gÃ¼n (etiketli, denenmemiÅŸ)
â€¢ **Ãœretim HatasÄ±:** SÃ¼resiz tam iade hakkÄ±
â€¢ **Renk SolmasÄ±:** 6 ay garanti kapsamÄ±nda
â€¢ **Beden DeÄŸiÅŸimi:** 2 defa Ã¼cretsiz (aynÄ± model)
â€¢ **KumaÅŸ Kalitesi:** 3 ay dokuma hatasÄ± garantisi

ğŸ  **Ev & Mobilya Garantileri:**
â€¢ **Mobilya:** 1 yÄ±l yapÄ±sal garanti + 3 yÄ±l metal aksam
â€¢ **Dekorasyon:** 6 ay malzeme garantisi
â€¢ **BahÃ§e ÃœrÃ¼nleri:** 1 sezon (6 ay) garanti
â€¢ **AydÄ±nlatma:** 2 yÄ±l garanti + LED 5 yÄ±l

ğŸ”§ **Teknik Servis AÄŸÄ±mÄ±z:**
â€¢ **81 Ä°lde** 450+ yetkili servis noktasÄ±
â€¢ **Evde Servis:** BÃ¼yÃ¼k ÅŸehirlerde Ã¼cretsiz
â€¢ **Express OnarÄ±m:** 24-48 saat (ek Ã¼cretli)
â€¢ **Yedek ÃœrÃ¼n:** OnarÄ±m sÃ¼resince geÃ§ici Ã¼rÃ¼n
â€¢ **Mobil Servis:** AraÃ§la gelip onarÄ±m
â€¢ **Online Randevu:** servistakip.com

ğŸ“‹ **Garanti KapsamÄ±:**
â€¢ Ãœretim hatalarÄ± (malzeme, iÅŸÃ§ilik)
â€¢ Erken arÄ±zalanma (normal kullanÄ±mda)
â€¢ Performans dÃ¼ÅŸÃ¼klÃ¼ÄŸÃ¼ (spesifikasyon altÄ±)
â€¢ Orijinal yedek parÃ§a garantisi
â€¢ YazÄ±lÄ±m gÃ¼ncellemeleri (2 yÄ±l)

âŒ **Garanti KapsamÄ± DÄ±ÅŸÄ±nda:**
â€¢ KullanÄ±cÄ± kaynaklÄ± hasar (dÃ¼ÅŸÃ¼rme, darbe)
â€¢ Su/nem temasÄ± (banyo, yaÄŸmur vb.)
â€¢ Yetkisiz tamircide onarÄ±m giriÅŸimi
â€¢ Elektrik problemi kaynaklÄ± arÄ±za
â€¢ YanlÄ±ÅŸ kullanÄ±m sonucu hasar
â€¢ DoÄŸal afet/kaza sonucu hasar

ğŸ“ **Garanti Destek HatlarÄ±:**
â€¢ **Genel garanti bilgi:** 444 0 124
â€¢ **Teknik destek hattÄ±:** 444 0 129
â€¢ **Servis randevu:** 444 0 130
â€¢ **Yedek parÃ§a sipariÅŸ:** 444 0 131

ğŸŒ **Online Garanti Hizmetleri:**
â€¢ **garantisor.com** - Garanti durumu sorgulama
â€¢ **servistakip.com** - OnarÄ±m sÃ¼reÃ§ takibi  
â€¢ **yedekparca.com** - Online parÃ§a sipariÅŸi
â€¢ **Mobil uygulama** - QR kod ile hÄ±zlÄ± eriÅŸim"""
    }
    
    return policies.get(topic.lower(), f"""â“ **'{topic.title()}' Konusunda Bilgi**

Bu konuda size daha detaylÄ± bilgi vermek iÃ§in:

ğŸ“ **MÃ¼ÅŸteri Hizmetleri HatlarÄ±:**
â€¢ **Ana hat:** 444 0 123 (7/24 genel destek)
â€¢ **SipariÅŸ & Ä°ade:** 444 0 125  
â€¢ **Kargo & Teslimat:** 444 0 126
â€¢ **Ã–deme & Fatura:** 444 0 127
â€¢ **Garanti & Servis:** 444 0 124

ğŸ’¬ **DiÄŸer Ä°letiÅŸim KanallarÄ±:**
â€¢ **Whatsapp destek:** +90 555 123 45 67
â€¢ **CanlÄ± destek:** Website chat (09:00-22:00)
â€¢ **Email destek:** bilgi@example.com
â€¢ **Social media:** @ExampleTurkiye (Twitter, Instagram)
â€¢ **Video gÃ¶rÃ¼ÅŸme:** Uzman ile gÃ¶rÃ¼ntÃ¼lÃ¼ destek

â° **Destek Saatleri:**
â€¢ **Hafta iÃ§i:** 08:00 - 22:00 (tam destek)
â€¢ **Hafta sonu:** 09:00 - 19:00 (sÄ±nÄ±rlÄ± destek)  
â€¢ **Resmi tatiller:** 10:00 - 18:00 (acil durumlar)
â€¢ **7/24 HattÄ±:** 444 0 123 (otomatik sistem + acil)""")

def analyze_intent(message: str) -> Dict[str, Any]:
    message_lower = message.lower()
    
    # SipariÅŸ takibi - geliÅŸtirilmiÅŸ
    order_patterns = [
        r'(\d{4,8})\s*(?:nolu|numaralÄ±|no\.?)\s*(?:sipariÅŸ|order)',
        r'(?:sipariÅŸ|order)\s*(?:no|numarasÄ±)?:?\s*(\d{4,8})',
        r'(\d{4,8})\s*(?:takip|track|nerede|where)',
        r'(\d{4,8}).*(?:durum|status)'
    ]
    
    for pattern in order_patterns:
        match = re.search(pattern, message_lower)
        if match:
            return {"intent": "sipariÅŸ_takip", "parameters": {"order_id": match.group(1)}, "requires_tool": True}
    
    # Kargo hesaplama
    cities = ['istanbul', 'ankara', 'izmir', 'antalya', 'bursa', 'adana', 'gaziantep', 'trabzon']
    found_city = next((city for city in cities if city in message_lower), None)
    
    weight_match = re.search(r'(\d+(?:[.,]\d+)?)\s*(?:kg|kilo)', message_lower)
    weight = float(weight_match.group(1).replace(",", ".")) if weight_match else 1.0
    
    if found_city and any(word in message_lower for word in ['kargo', 'Ã¼cret', 'fiyat', 'maliyet', 'gÃ¶nderi']):
        return {"intent": "kargo_hesaplama", "parameters": {"city": found_city, "weight": weight}, "requires_tool": True}
    
    # Politika sorgularÄ±
    policy_keywords = {
        "iade": ["iade", "geri", "dÃ¶ndÃ¼r", "deÄŸiÅŸ", "return"],
        "kargo": ["kargo", "teslimat", "gÃ¶nderi", "delivery", "courier"],
        "Ã¶deme": ["Ã¶deme", "para", "kart", "payment", "taksit"],
        "garanti": ["garanti", "warranty", "bozuk", "arÄ±za", "servis"]
    }
    
    for topic, keywords in policy_keywords.items():
        if any(keyword in message_lower for keyword in keywords):
            return {"intent": "politika_sorgula", "parameters": {"topic": topic}, "requires_tool": True}
    
    return {"intent": "genel_sohbet", "parameters": {}, "requires_tool": False}

# UPDATED Groq API with current models
async def call_groq_api(messages: List[Dict]) -> str:
    try:
        # Groq'un aktif modelleri (2024-2025)
        models = [
            "llama-3.1-70b-versatile",  # En gÃ¼Ã§lÃ¼
            "llama-3.1-8b-instant",    # HÄ±zlÄ±
            "mixtral-8x7b-32768",      # Uzun context
            "llama3-70b-8192",         # Stabil
            "llama3-8b-8192"           # HÄ±zlÄ± (eski)
        ]
        
        # Try different models in order
        for model in models:
            try:
                clean_messages = []
                for msg in messages:
                    if isinstance(msg, dict) and 'role' in msg and 'content' in msg:
                        content = str(msg['content']).strip()
                        if content and len(content) < 3000:
                            clean_messages.append({"role": msg['role'], "content": content})
                
                if not clean_messages:
                    raise Exception("No valid messages")
                
                payload = {
                    "model": model,
                    "messages": clean_messages,
                    "max_tokens": 350,
                    "temperature": 0.7,
                    "top_p": 0.9,
                    "stream": False
                }
                
                headers = {
                    "Authorization": f"Bearer {GROQ_API_KEY}",
                    "Content-Type": "application/json",
                    "Accept": "application/json"
                }
                
                async with httpx.AsyncClient(timeout=15.0) as client:
                    response = await client.post(
                        "https://api.groq.com/openai/v1/chat/completions",
                        json=payload,
                        headers=headers
                    )
                    
                    if response.status_code == 200:
                        data = response.json()
                        if 'choices' in data and data['choices']:
                            result = data['choices'][0]['message']['content'].strip()
                            logger.info(f"Groq success with model: {model}")
                            return result
                        else:
                            continue
                    elif response.status_code == 400:
                        error_data = response.json()
                        if "decommissioned" in str(error_data):
                            logger.warning(f"Model {model} decommissioned, trying next...")
                            continue
                        else:
                            raise Exception(f"Groq API error: {error_data}")
                    else:
                        continue
                        
            except Exception as e:
                logger.warning(f"Model {model} failed: {e}")
                continue
        
        raise Exception("All Groq models failed")
        
    except Exception as e:
        logger.error(f"Groq call completely failed: {e}")
        raise e

# Ollama API (unchanged)
async def call_ollama_api(messages: List[Dict]) -> str:
    try:
        if not ollama_base_url:
            raise Exception("Ollama not available")
        
        prompt_parts = []
        for msg in messages:
            role = msg.get('role', 'user')
            content = str(msg.get('content', '')).strip()
            if content:
                if role == 'system':
                    prompt_parts.append(f"Sistem: {content}")
                elif role == 'user':
                    prompt_parts.append(f"KullanÄ±cÄ±: {content}")
                elif role == 'assistant':
                    prompt_parts.append(f"Asistan: {content}")
        
        prompt = "\n".join(prompt_parts) + "\nAsistan:"
        
        payload = {
            "model": "llama3.2",
            "prompt": prompt,
            "stream": False,
            "options": {"temperature": 0.7, "num_predict": 250}
        }
        
        async with httpx.AsyncClient(timeout=20.0) as client:
            response = await client.post(f"{ollama_base_url}/api/generate", json=payload)
            
            if response.status_code == 200:
                data = response.json()
                return data.get("response", "").strip()
            else:
                raise Exception(f"Ollama error: {response.status_code}")
                
    except Exception as e:
        logger.error(f"Ollama call failed: {e}")
        raise e

def smart_fallback(message: str) -> str:
    message_lower = message.lower()
    
    # Quick responses
    quick_responses = {
        "merhaba": ["ğŸ™‹â€â™‚ï¸ Merhaba! Size nasÄ±l yardÄ±mcÄ± olabilirim?", "ğŸ‘‹ Selam! BugÃ¼n size nasÄ±l destek olabilirim?"],
        "gÃ¼naydÄ±n": ["ğŸŒ… GÃ¼naydÄ±n! Ä°yi gÃ¼nler, size nasÄ±l yardÄ±mcÄ± olabilirim?"],
        "iyi akÅŸam": ["ğŸŒ† Ä°yi akÅŸamlar! Size nasÄ±l destek olabilirim?"],
        "nasÄ±l": ["ğŸ˜Š Ben bir AI asistanÄ±yÄ±m, sÃ¼rekli Ã¶ÄŸreniyorum! Size nasÄ±l yardÄ±mcÄ± olabilirim?"],
        "teÅŸekkÃ¼r": ["ğŸ™ Rica ederim! BaÅŸka sorunuz var mÄ±?", "ğŸ˜Š Ne demek! Size daha nasÄ±l yardÄ±mcÄ± olabilirim?"],
        "bye": ["ğŸ‘‹ GÃ¶rÃ¼ÅŸÃ¼rÃ¼z! Ä°yi gÃ¼nler dilerim!", "ğŸ™‹â€â™‚ï¸ HoÅŸÃ§a kalÄ±n! Tekrar gÃ¶rÃ¼ÅŸmek Ã¼zere!"]
    }
    
    for key, responses in quick_responses.items():
        if key in message_lower:
            return random.choice(responses)
    
    # Help requests
    if any(word in message_lower for word in ["yardÄ±m", "help", "destek", "neler yapabilir"]):
        return """ğŸ†˜ **YARDIM MENÃœSÃœ**

âœ… **Size YardÄ±mcÄ± OlabileceÄŸim Konular:**

ğŸ›ï¸ **SipariÅŸ Takibi**
"12345 numaralÄ± sipariÅŸim nerede?"
"67890 sipariÅŸimin durumu ne?"

ğŸ“¦ **Kargo Hesaplama** 
"Ä°stanbul'a 2kg kargo ne kadar?"
"Ankara'ya express kargo Ã¼creti?"

ğŸ“‹ **Politika Bilgileri**
"Ä°ade nasÄ±l yaparÄ±m?" 
"Hangi kartlarÄ± kabul ediyorsunuz?"
"Garanti sÃ¼resi ne kadar?"

ğŸ’¬ **Genel Sorular**
"MÃ¼ÅŸteri hizmetleri numarasÄ±?"
"Ã‡alÄ±ÅŸma saatleri nedir?"

Hangi konuda yardÄ±m istersiniz? ğŸ˜Š"""
    
    # Contextual responses
    response_templates = [
        f"'{message}' konusunda size yardÄ±mcÄ± olmaya Ã§alÄ±ÅŸayÄ±m. Bu konuda daha spesifik ne Ã¶ÄŸrenmek istiyorsunuz? ğŸ¤”",
        f"AnlÄ±yorum, '{message}' hakkÄ±nda bilgi arÄ±yorsunuz. Size nasÄ±l destek olabilirim? ğŸ’­",
        f"'{message}' ile ilgili sorunuz iÃ§in buradayÄ±m. DetayÄ±na inelim mi? ğŸ”"
    ]
    
    return random.choice(response_templates)

async def generate_response(message: str, session_id: str, tool_result: str = None) -> str:
    if tool_result:
        return f"Ä°ÅŸte istediÄŸiniz bilgiler:\n\n{tool_result}"
    
    history = session_memory.get(session_id, [])
    
    # Try AI providers in order
    try:
        if ai_provider == "groq" and groq_available:
            try:
                messages = [
                    {"role": "system", "content": "Sen profesyonel bir mÃ¼ÅŸteri hizmetleri asistanÄ±sÄ±n. TÃ¼rkÃ§e konuÅŸuyorsun, samimi ama profesyonelsin. KÄ±sa ve net yanÄ±tlar veriyorsun."}
                ]
                
                # Add recent history (max 2)
                for msg in history[-2:]:
                    if isinstance(msg, dict) and 'role' in msg and 'content' in msg:
                        messages.append(msg)
                
                messages.append({"role": "user", "content": message})
                
                response = await call_groq_api(messages)
                provider_used = "groq"
                
            except Exception as e:
                logger.warning(f"Groq failed, trying Ollama: {e}")
                if ollama_available:
                    messages = [
                        {"role": "system", "content": "Sen mÃ¼ÅŸteri hizmetleri asistanÄ±sÄ±n."},
                        {"role": "user", "content": message}
                    ]
                    response = await call_ollama_api(messages)
                    provider_used = "ollama"
                else:
                    response = smart_fallback(message)
                    provider_used = "smart_fallback"
                    
        elif ai_provider == "ollama" and ollama_available:
            messages = [
                {"role": "system", "content": "Sen mÃ¼ÅŸteri hizmetleri asistanÄ±sÄ±n."},
                {"role": "user", "content": message}
            ]
            response = await call_ollama_api(messages)
            provider_used = "ollama"
        else:
            response = smart_fallback(message)
            provider_used = "smart_fallback"
        
        # Update memory
        if session_id not in session_memory:
            session_memory[session_id] = []
        
        session_memory[session_id].extend([
            {"role": "user", "content": message},
            {"role": "assistant", "content": response}
        ])
        
        if len(session_memory[session_id]) > 8:
            session_memory[session_id] = session_memory[session_id][-8:]
        
        logger.info(f"Response by: {provider_used}")
        return response
        
    except Exception as e:
        logger.error(f"All providers failed: {e}")
        return smart_fallback(message)

# Endpoints
@app.get("/")
def read_root():
    return {
        "message": "WebChat AI Assistant",
        "ai_provider": ai_provider,
        "groq_available": groq_available,
        "ollama_available": ollama_available,
        "timestamp": datetime.now().isoformat()
    }

@app.get("/api/health")
def health_check():
    return {
        "status": "healthy",
        "ai_provider": ai_provider,
        "providers": {
            "groq": {"available": groq_available, "models": ["llama-3.1-70b-versatile", "llama-3.1-8b-instant"]},
            "ollama": {"available": ollama_available, "model": "llama3.2"},
            "smart_fallback": {"available": True, "model": "rule-based"}
        }
    }

@app.get("/demo", response_class=HTMLResponse)
def demo():
    provider_names = {
        "groq": "ğŸš€ Groq AI (Updated)",
        "ollama": "ğŸ  Ollama Local", 
        "smart_fallback": "ğŸ§  Smart Fallback"
    }
    
    status_color = "#00d4aa" if ai_provider == "groq" else "#1976d2" if ai_provider == "ollama" else "#ff9800"
    
    return f'''<!DOCTYPE html>
<html>
<head>
    <title>WebChat AI Assistant</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {{ margin: 0; padding: 0; box-sizing: border-box; }}
        body {{ 
            font-family: system-ui, sans-serif; 
            background: linear-gradient(135deg, #667eea, #764ba2);
            min-height: 100vh; padding: 20px;
        }}
        .container {{
            max-width: 1000px; margin: 0 auto; background: white;
            padding: 40px; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.15);
        }}
        h1 {{ color: #1f6feb; text-align: center; font-size: 2.8em; margin-bottom: 20px; }}
        .provider-badge {{ 
            background: {status_color}; color: white; padding: 12px 25px; 
            border-radius: 25px; font-weight: bold; display: inline-block; margin-bottom: 30px;
        }}
        
        #webchatai-toggle {{
            position: fixed; right: 25px; bottom: 25px;
            width: 70px; height: 70px; border-radius: 50%;
            background: linear-gradient(45deg, #1f6feb, #4f46e5);
            color: white; border: none; cursor: pointer; z-index: 999999;
            font-size: 30px; box-shadow: 0 10px 30px rgba(31,111,235,0.4);
            transition: all 0.3s ease;
        }}
        #webchatai-toggle:hover {{ transform: scale(1.1); }}
        
        #webchatai-panel {{
            position: fixed; right: 25px; bottom: 105px;
            width: 380px; height: 550px; background: white;
            border-radius: 20px; display: none; flex-direction: column;
            z-index: 999998; box-shadow: 0 25px 60px rgba(0,0,0,0.2);
            animation: slideUp 0.4s ease;
        }}
        @keyframes slideUp {{ from {{ opacity: 0; transform: translateY(20px); }} to {{ opacity: 1; transform: translateY(0); }} }}
        
        .header {{ 
            background: linear-gradient(135deg, #1f6feb, #0d47a1);
            color: white; padding: 20px; border-radius: 20px 20px 0 0;
            display: flex; justify-content: space-between; align-items: center;
        }}
        .provider-info {{ font-size: 11px; background: rgba(255,255,255,0.2); padding: 3px 8px; border-radius: 10px; }}
        .close-btn {{ background: transparent; border: none; color: white; cursor: pointer; font-size: 24px; }}
        
        .body {{ flex: 1; padding: 20px; overflow-y: auto; background: #f8fafc; }}
        .input {{ 
            display: flex; padding: 20px; gap: 12px; background: white;
            border-top: 1px solid #e2e8f0;
        }}
        .input input {{ 
            flex: 1; padding: 14px 18px; border: 2px solid #e2e8f0;
            border-radius: 25px; outline: none;
        }}
        .input input:focus {{ border-color: #1f6feb; }}
        .input button {{ 
            padding: 14px 24px; background: linear-gradient(45deg, #1f6feb, #4f46e5);
            color: white; border: none; border-radius: 25px; cursor: pointer; font-weight: 600;
        }}
        
        .msg {{ 
            margin: 15px 0; padding: 15px 20px; border-radius: 20px;
            max-width: 85%; word-wrap: break-word; line-height: 1.4;
            animation: fadeIn 0.3s ease;
        }}
        @keyframes fadeIn {{ from {{ opacity: 0; }} to {{ opacity: 1; }} }}
        
        .user {{ 
            background: linear-gradient(135deg, #1f6feb, #4f46e5);
            color: white; margin-left: auto; text-align: right;
        }}
        .assistant {{ background: white; color: #374151; border: 2px solid #e2e8f0; }}
        .typing {{ 
            background: white; color: #6b7280; font-style: italic;
            border: 2px solid #e2e8f0; animation: pulse 1.5s infinite;
        }}
        @keyframes pulse {{ 0%, 100% {{ opacity: 1; }} 50% {{ opacity: 0.6; }} }}
        
        .info-grid {{ 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; margin: 30px 0; 
        }}
        .info-card {{
            background: white; padding: 25px; border-radius: 15px;
            border-left: 4px solid #1f6feb; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }}
        .info-card h4 {{ color: #1f6feb; margin-bottom: 10px; }}
        
        .status-info {{
            background: #f0f9ff; padding: 25px; border-radius: 15px; 
            margin: 25px 0; border-left: 5px solid #1f6feb;
        }}
        
        @media (max-width: 480px) {{
            #webchatai-panel {{ right: 15px; left: 15px; width: auto; }}
            .container {{ padding: 25px; }}
        }}
    </style>
</head>
<body>
    <div class="container">
        <div class="provider-badge">{provider_names[ai_provider]}</div>
        <h1>WebChat AI Assistant</h1>
        
        <div class="status-info">
            <h3>ğŸ¯ GÃ¼ncellenmiÅŸ AI Chat Widget</h3>
            <p><strong>SaÄŸ-alt kÃ¶ÅŸedeki AI butonuna tÄ±klayÄ±n!</strong></p>
            <p>Aktif sistem: <strong>{provider_names[ai_provider]}</strong></p>
            {'<p style="color: #10b981;"><strong>âœ… Groq models updated - working!</strong></p>' if ai_provider == 'groq' else ''}
        </div>
        
        <div class="info-grid">
            <div class="info-card">
                <h4>ğŸš€ Groq Cloud</h4>
                <p>Status: {'âœ… Active (Updated Models)' if ai_provider == 'groq' else 'âŒ API Issue' if groq_available else 'âš ï¸ API Key Missing'}</p>
                <small>Models: llama-3.1-70b, llama-3.1-8b</small>
            </div>
            <div class="info-card">
                <h4>ğŸ  Ollama Local</h4>
                <p>Status: {'âœ… Active' if ai_provider == 'ollama' else 'âš¡ Standby' if ollama_available else 'âŒ Not Available'}</p>
                <small>Model: llama3.2</small>
            </div>
            <div class="info-card">
                <h4>ğŸ§  Smart Fallback</h4>
                <p>Status: {'âœ… Active' if ai_provider == 'smart_fallback' else 'âš¡ Standby'}</p>
                <small>Rule-based responses</small>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin: 30px 0;">
            <div style="background: #f8fafc; padding: 20px; border-radius: 10px;">
                <h4>ğŸ›ï¸ SipariÅŸ Takibi</h4>
                <p>"12345 numaralÄ± sipariÅŸim nerede?"</p>
            </div>
            <div style="background: #f8fafc; padding: 20px; border-radius: 10px;">
                <h4>ğŸ“¦ Kargo Hesaplama</h4>
                <p>"Ä°stanbul'a 2kg kargo ne kadar?"</p>
            </div>
            <div style="background: #f8fafc; padding: 20px; border-radius: 10px;">
                <h4>ğŸ“‹ Politika Sorgusu</h4>
                <p>"Ä°ade nasÄ±l yaparÄ±m?"</p>
            </div>
            <div style="background: #f8fafc; padding: 20px; border-radius: 10px;">
                <h4>ğŸ’¬ AI Sohbet</h4>
                <p>"Merhaba, nasÄ±lsÄ±n?"</p>
            </div>
        </div>
    </div>
    
    <button id="webchatai-toggle">ğŸ¤–</button>
    <div id="webchatai-panel">
        <div class="header">
            <div>
                <h3>WebChat AI</h3>
                <div class="provider-info">{ai_provider.upper()}</div>
            </div>
            <button class="close-btn" onclick="closeChat()">âœ•</button>
        </div>
        <div class="body" id="chat-body">
            <div class="msg assistant">ğŸ¤– Merhaba! Ben gÃ¼ncellenmiÅŸ AI asistanÄ±yÄ±m.</div>
            <div class="msg assistant">âœ¨ Size nasÄ±l yardÄ±mcÄ± olabilirim?</div>
        </div>
        <div class="input">
            <input id="chat-input" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..." />
            <button onclick="sendMessage()">GÃ¶nder</button>
        </div>
    </div>
    
    <script>
        const sessionId = 'updated-' + Math.random().toString(36).substr(2, 9);
        let isOpen = false;
        
        document.getElementById('webchatai-toggle').onclick = function() {{
            const panel = document.getElementById('webchatai-panel');
            isOpen = !isOpen;
            panel.style.display = isOpen ? 'flex' : 'none';
            if (isOpen) document.getElementById('chat-input').focus();
        }};
        
        function closeChat() {{
            document.getElementById('webchatai-panel').style.display = 'none';
            isOpen = false;
        }}
        
        function addMessage(type, text) {{
            const body = document.getElementById('chat-body');
            const div = document.createElement('div');
            div.className = 'msg ' + type;
            div.innerHTML = text.replace(/\\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            body.appendChild(div);
            body.scrollTop = body.scrollHeight;
        }}
        
        function showTyping() {{
            const body = document.getElementById('chat-body');
            const div = document.createElement('div');
            div.className = 'msg typing';
            div.id = 'typing-indicator';
            div.textContent = 'ğŸ¤– YanÄ±tlÄ±yor...';
            body.appendChild(div);
            body.scrollTop = body.scrollHeight;
        }}
        
        function removeTyping() {{
            const typing = document.getElementById('typing-indicator');
            if (typing) typing.remove();
        }}
        
        async function sendMessage() {{
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;
            
            addMessage('user', message);
            input.value = '';
            showTyping();
            
            try {{
                const response = await fetch('/api/chat', {{
                    method: 'POST',
                    headers: {{ 'Content-Type': 'application/json' }},
                    body: JSON.stringify({{ message, session_id: sessionId }})
                }});
                
                const data = await response.json();
                
                setTimeout(() => {{
                    removeTyping();
                    addMessage('assistant', data.response || 'YanÄ±t alÄ±namadÄ±');
                    console.log('Provider:', '{ai_provider}', data.metadata);
                }}, 1000);
                
            }} catch (error) {{
                setTimeout(() => {{
                    removeTyping();
                    addMessage('assistant', 'âŒ BaÄŸlantÄ± hatasÄ±.');
                }}, 500);
            }}
        }}
        
        document.getElementById('chat-input').addEventListener('keydown', function(e) {{
            if (e.key === 'Enter') sendMessage();
        }});
        
        console.log('ğŸ¤– Updated WebChat ready! Provider: {ai_provider}');
    </script>
</body>
</html>'''

@app.post("/api/chat")
async def chat_endpoint(chat_message: ChatMessage) -> ChatResponse:
    message = chat_message.message
    session_id = chat_message.session_id
    
    logger.info(f"Chat: {message[:30]}... [{ai_provider}]")
    
    try:
        # Intent analysis
        intent_data = analyze_intent(message)
        
        # Tool calling
        tool_result = None
        if intent_data.get("requires_tool"):
            params = intent_data.get("parameters", {})
            intent = intent_data.get("intent")
            
            if intent == "sipariÅŸ_takip":
                tool_result = get_order_status(params.get("order_id", ""))
            elif intent == "kargo_hesaplama":
                tool_result = calculate_shipping(params.get("city", ""), params.get("weight", 1.0))
            elif intent == "politika_sorgula":
                tool_result = get_policy_info(params.get("topic", ""))
        
        # Generate response
        response = await generate_response(message, session_id, tool_result)
        
        return ChatResponse(
            response=response,
            session_id=session_id,
            metadata={
                "intent": intent_data.get("intent"),
                "tool_used": bool(tool_result),
                "ai_provider": ai_provider
            }
        )
        
    except Exception as e:
        logger.error(f"Chat error: {e}")
        return ChatResponse(
            response="âŒ ÃœzgÃ¼nÃ¼m, sorun yaÅŸÄ±yorum. Tekrar deneyin.",
            session_id=session_id,
            metadata={"error": str(e)}
        )

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)
