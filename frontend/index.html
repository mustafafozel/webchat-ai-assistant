<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WebChat AI Assistant â€” Popup</title>

  <!-- Tailwind CDN (prototype, no build step) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --brand: #2563eb; /* Etkin.ai blue-ish */
      --bubble-user: linear-gradient(180deg,#22c55e,#16a34a);
      --bubble-assistant-bg: #ffffff;
      --bubble-assistant-border: rgba(0,0,0,0.06);
      --popup-width: 420px;
      --popup-radius: 14px;
    }
    html,body{height:100%; margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    /* Floating button */
    .fab {
      position: fixed;
      right: 20px;
      bottom: 20px;
      z-index: 9999;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 8px 28px rgba(37,99,235,0.18);
    }
    .fab-button {
      display: inline-flex;
      align-items: center;
      gap: .6rem;
      background: var(--brand);
      color: white;
      padding: .55rem .85rem;
      border-radius: 999px;
      font-weight: 600;
      cursor: pointer;
      transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease;
    }
    .fab-button:hover{ transform: translateY(-3px); opacity: .98; box-shadow: 0 12px 34px rgba(37,99,235,0.22); }

    .fab-icon {
      width: 1.6rem;
      height: 1.6rem;
      display: inline-flex;
      align-items:center;
      justify-content:center;
      background: rgba(255,255,255,0.12);
      border-radius: 8px;
    }

    /* Popup container */
    .chat-popup {
      display: flex;
      flex-direction: column;
      position: fixed;
      right: 20px;
      bottom: 80px;
      z-index: 9998;
      width: var(--popup-width);
      max-height: 78vh;
      border-radius: var(--popup-radius);
      overflow: hidden;
      box-shadow: 0 12px 44px rgba(2,6,23,0.12);
      display: none; /* default closed */
      background: linear-gradient(180deg,#fbfdff,#ffffff);
      border: 1px solid rgba(2,6,23,0.04);
      transition: transform .12s ease, opacity .12s ease;
    }

    .chat-header {
      display:flex;
      align-items:center;
      gap:.75rem;
      padding: .9rem .9rem;
      background: linear-gradient(90deg, rgba(37,99,235,0.06), rgba(37,99,235,0.02));
      border-bottom: 1px solid rgba(2,6,23,0.03);
    }
    .chat-title { font-weight:700; color:#0f172a; }
    .chat-sub { color:#475569; font-size: .85rem; }

    .messages {
      padding: .85rem;
      display: flex;
      flex-direction: column;
      gap: .6rem;
      overflow-y: auto;
      overflow-x: hidden;
      scroll-behavior: smooth;
      background-image: linear-gradient(to bottom, rgba(0,0,0,0.01), transparent 60%);
      flex: 1 1 auto;
      height: calc(78vh - 150px); /* Header + composer kadar yer bÄ±rakÄ±r */
      max-height: calc(78vh - 150px);
    }

    .bubble {
      max-width: calc(var(--popup-width) - 80px);
      padding: .6rem .9rem;
      border-radius: 14px;
      line-height:1.25;
      word-wrap: break-word;
      white-space: pre-wrap;
      box-shadow: 0 1px 0 rgba(0,0,0,0.03);
      font-size: 0.96rem;
    }
    .bubble.user {
      margin-left: auto;
      background: var(--bubble-user);
      color: white;
      border-bottom-right-radius: 6px;
    }
    .bubble.assistant {
      margin-right: auto;
      background: var(--bubble-assistant-bg);
      color: #0f172a;
      border: 1px solid var(--bubble-assistant-border);
      border-bottom-left-radius: 6px;
    }

    .meta { font-size: .68rem; color:#6b7280; margin-top:.28rem; }

    /* Typing indicator (ephemeral) */
    .typing {
      display:flex;
      align-items:center;
      gap: .6rem;
      padding: .5rem .7rem;
      background: #f1f5f9;
      border-radius: 12px;
      color:#374151;
      width: fit-content;
      border: 1px solid rgba(0,0,0,0.03);
      animation: pulse 1.6s infinite;
    }
    .typing-dot {
      width: 7px;
      height:7px;
      background: #94a3b8;
      border-radius: 999px;
      opacity: .95;
      margin-right: .2rem;
      box-shadow: 0 1px 0 rgba(0,0,0,0.02);
    }
    @keyframes pulse {
      0% { transform: translateY(0); }
      50% { transform: translateY(-2px); }
      100% { transform: translateY(0); }
    }

    .composer {
      display:flex;
      gap:.6rem;
      padding: .85rem;
      border-top: 1px solid rgba(2,6,23,0.03);
      background: linear-gradient(180deg,#ffffff,#fbfbfd);
      align-items: center;
    }

    .input {
      flex:1;
      border-radius: 999px;
      padding: .65rem .9rem;
      border: 1px solid rgba(2,6,23,0.06);
      resize:none;
      min-height:40px;
      max-height:140px;
      font-size: .95rem;
      outline:none;
    }

    .send-btn {
      background: var(--brand);
      color: white;
      padding: .55rem .85rem;
      border-radius: 999px;
      cursor:pointer;
      font-weight:600;
    }
    .send-btn:active { transform:translateY(1px); }
    .close-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      color: #475569;
      font-weight:700;
    }

    /* mobile adjustments: popup expands to near full-screen */
    @media (max-width: 640px) {
      .chat-popup {
        left: 10px;
        right: 10px;
        bottom: 16px;
        width: calc(100% - 20px);
        max-height: calc(100vh - 110px);
        border-radius: 12px;
      }
      .fab { right: 14px; bottom: 14px; }
    }
  </style>
</head>
<body>

  <!-- Floating action button (closed default) -->
  <div class="fab" aria-hidden="false">
    <div id="fab-launch" class="fab-button" role="button" aria-pressed="false" title="Sohbet BaÅŸlat">
      <div class="fab-icon" aria-hidden="true">
        <!-- message icon -->
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 15a2 2 0 0 1-2 2H8l-5 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" fill="white"/></svg>
      </div>
      <div>Sohbet BaÅŸlat</div>
    </div>
  </div>

  <!-- Popup -->
  <div id="chatPopup" class="chat-popup" role="dialog" aria-label="WebChat AsistanÄ±">
    <div class="chat-header">
      <div style="display:flex;align-items:center;gap:.6rem;">
        <div style="width:44px;height:44px;border-radius:10px;background:var(--brand);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;">AI</div>
        <div>
          <div class="chat-title">WebChat AI Assistant</div>
          <div class="chat-sub">Size nasÄ±l yardÄ±mcÄ± olabilirim?</div>
        </div>
      </div>
      <div style="margin-left:auto;display:flex;gap:.4rem;align-items:center;">
        <button id="minimizeBtn" class="close-btn" title="Kapat">âœ•</button>
      </div>
    </div>

    <div id="messages" class="messages" aria-live="polite"></div>

    <div class="composer">
      <textarea id="input" class="input" placeholder="Mesaj yaz... (Enter gÃ¶nder, Shift+Enter yeni satÄ±r)"></textarea>
      <button id="sendBtn" class="send-btn">GÃ¶nder</button>
    </div>
  </div>

<script>
(function(){
  // Configuration
  const WS_BASE = "ws://localhost:8000/ws?session_id=";
  const REST_CHAT = "/api/chat";
  const RECONNECT_MS = 2000;
  const MAX_DOM_MESSAGES = 300;

  // UI elements
  const fabLaunch = document.getElementById('fab-launch');
  const chatPopup = document.getElementById('chatPopup');
  const messagesEl = document.getElementById('messages');
  const inputEl = document.getElementById('input');
  const sendBtn = document.getElementById('sendBtn');
  const minimizeBtn = document.getElementById('minimizeBtn');

  // Session id management
  function getOrCreateSessionId() {
    let sid = localStorage.getItem('webchat_session_id');
    if (!sid) {
      try { sid = crypto.randomUUID(); } catch(e) { sid = 'sess-' + Date.now(); }
      localStorage.setItem('webchat_session_id', sid);
    }
    return sid;
  }
  function regenerateSessionId() {
    const sid = (crypto.randomUUID ? crypto.randomUUID() : ('sess-' + Date.now()));
    localStorage.setItem('webchat_session_id', sid);
    return sid;
  }

  // State
  let ws = null;
  let connected = false;
  let typingIndicatorNode = null;
  let lastAssistantChunk = null;

  // Helpers: UI
  function openPopup() {
    chatPopup.style.display = 'block';
    chatPopup.style.transform = 'translateY(0)';
    // focus input
    setTimeout(()=> inputEl.focus(), 180);
  }
  function closePopup() {
    chatPopup.style.display = 'none';
  }
  function togglePopup() {
    if (chatPopup.style.display === 'block') closePopup();
    else openPopup();
  }

  // Append user bubble immediately
  function appendUserMessage(text) {
    const wrapper = document.createElement('div');
    const bubble = document.createElement('div');
    bubble.className = 'bubble user';
    bubble.textContent = text;
    wrapper.appendChild(bubble);
    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.textContent = 'Siz Â· ' + new Date().toLocaleTimeString();
    wrapper.appendChild(meta);
    messagesEl.appendChild(wrapper);
    scrollToBottom();
    trimMessages();
  }

  function appendSystemMessage(text) {
    const wrapper = document.createElement('div');
    const bubble = document.createElement('div');
    bubble.className = 'bubble assistant';
    bubble.style.background = '#f8fafc';
    bubble.style.fontSize = '.85rem';
    bubble.style.color = '#475569';
    bubble.textContent = text;
    wrapper.appendChild(bubble);
    messagesEl.appendChild(wrapper);
    scrollToBottom();
    trimMessages();
  }

  // Append assistant bubble
  function appendAssistantMessage(text) {
    // Remove typing indicator if present
    removeTypingIndicator();

    const wrapper = document.createElement('div');
    const bubble = document.createElement('div');
    bubble.className = 'bubble assistant';
    bubble.textContent = text;
    wrapper.appendChild(bubble);
    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.textContent = 'Asistan Â· ' + new Date().toLocaleTimeString();
    wrapper.appendChild(meta);
    messagesEl.appendChild(wrapper);
    scrollToBottom();
    trimMessages();
  }

  // Typing indicator ephemeral
  function showTypingIndicator() {
    // if already shown, keep
    if (typingIndicatorNode) return;
    const el = document.createElement('div');
    el.className = 'typing';
    el.setAttribute('data-typing', '1');
    // dots and text
    const dots = document.createElement('div');
    dots.style.display = 'flex';
    dots.style.gap = '.28rem';
    for (let i=0;i<3;i++){
      const d = document.createElement('div');
      d.className = 'typing-dot';
      dots.appendChild(d);
    }
    el.appendChild(dots);
    const txt = document.createElement('div');
    txt.style.fontSize = '.92rem';
    txt.style.color = '#374151';
    txt.style.fontWeight = 600;
    txt.textContent = 'Asistan yazÄ±yor...';
    el.appendChild(txt);

    // wrapper and append
    const wrapper = document.createElement('div');
    wrapper.style.display = 'flex';
    wrapper.style.flexDirection = 'column';
    wrapper.style.alignItems = 'flex-start';
    wrapper.style.marginRight = 'auto';
    wrapper.appendChild(el);

    messagesEl.appendChild(wrapper);
    typingIndicatorNode = wrapper;
    scrollToBottom();
  }
  function removeTypingIndicator() {
    if (!typingIndicatorNode) return;
    try { messagesEl.removeChild(typingIndicatorNode); } catch(e){}
    typingIndicatorNode = null;
  }

  function scrollToBottom(){
    setTimeout(() => {
      messagesEl.scrollTo({
        top: messagesEl.scrollHeight,
        behavior: 'smooth'
      });
    }, 80);
  }
  function trimMessages(){
    // limit DOM children count
    while (messagesEl.children.length > MAX_DOM_MESSAGES) {
      messagesEl.removeChild(messagesEl.firstChild);
    }
  }

  // WebSocket connection logic
  function connectWebSocket() {
    const sid = getOrCreateSessionId();

    // close existing
    try { if (ws) { ws.onopen = ws.onmessage = ws.onclose = ws.onerror = null; ws.close(); } } catch(e){}
    const url = WS_BASE + encodeURIComponent(sid);

    try {
      ws = new WebSocket(url);

      ws.onopen = () => {
        connected = true;
        // Optionally show ephemeral system message on open
        // appendSystem('BaÄŸlandÄ± (WebSocket)');
      };

      ws.onmessage = (ev) => {
        removeTypingIndicator();
        try {
          const payload = JSON.parse(ev.data);
          if (payload.type === 'response') {
            appendAssistantMessage(payload.response);
            if (payload.metadata && payload.metadata.kb_results && payload.metadata.kb_results.length) {
              appendSystemMessage('ðŸ“š Bilgi kaynaÄŸÄ±: ' + payload.metadata.kb_results[0]);
            }
          } else if (payload.type === 'error') {
            appendSystemMessage('âš ï¸ ' + (payload.error || 'Bilinmeyen hata'));
          } else if (typeof payload === 'string') {
            appendAssistantMessage(payload);
          }
        } catch (err) {
          const data = (ev.data || '').toString();
          if (data.trim() === 'Asistan yazÄ±yor...') {
            showTypingIndicator();
            return;
          }
          appendAssistantMessage(data);
        }
      };

      ws.onclose = (ev) => {
        connected = false;
        // show ephemeral system message
        appendSystemMessage('WebSocket baÄŸlantÄ±sÄ± kapandÄ± â€” yeniden baÄŸlanÄ±lÄ±yor...');
        // attempt reconnect after delay
        setTimeout(() => {
          connectWebSocket();
        }, RECONNECT_MS);
      };

      ws.onerror = (err) => {
        connected = false;
        // try to close to trigger reconnect
        try { ws.close(); } catch(e){}
      };

    } catch (e) {
      // fallback show
      const sys = document.createElement('div');
      sys.className = 'text-center text-xs text-red-400';
      sys.style.margin = '.4rem 0';
      sys.textContent = 'WebSocket baÅŸlatÄ±lamadÄ±: ' + (e && e.message ? e.message : e);
      messagesEl.appendChild(sys);
      scrollToBottom();
    }
  }

  // HTTP fallback
  async function sendHttpFallback(message, sid) {
    try {
      const res = await fetch(REST_CHAT, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({session_id: sid, message})
      });
      if (!res.ok) {
        const txt = await res.text();
        // show error system message
        appendSystemMessage('HTTP fallback hata: ' + res.status + ' ' + (txt || ''));
        return;
      }
      const j = await res.json();
      if (j && j.response) {
        appendAssistantMessage(j.response);
      } else {
        appendSystemMessage('HTTP fallback: Beklenmeyen cevap.');
      }
    } catch (e) {
      appendSystemMessage('HTTP fallback exception: ' + e.toString());
    }
  }

  // send message: tries WebSocket, falls back to HTTP automatically
  function sendMessage(message) {
    const sid = getOrCreateSessionId();
    appendUserMessage(message);

    if (ws && ws.readyState === WebSocket.OPEN) {
      // send message over ws â€” backend will likely send a typing placeholder first
      try {
        ws.send(message);
        // show ephemeral typing UI immediately (in case backend doesn't send typing text)
        showTypingIndicator();
      } catch (e) {
        // fallback to HTTP
        removeTypingIndicator();
        sendHttpFallback(message, sid);
      }
    } else {
      // fallback to HTTP
      sendHttpFallback(message, sid);
    }
  }

  // UI events
  fabLaunch.addEventListener('click', () => {
    togglePopup();
  });

  minimizeBtn.addEventListener('click', () => {
    closePopup();
  });

  // Keyboard: Enter to send, Shift+Enter newline
  inputEl.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendBtn.click();
    }
  });

  sendBtn.addEventListener('click', () => {
    const txt = inputEl.value.trim();
    if (!txt) return;
    const sid = getOrCreateSessionId();
    sendMessage(txt);
    inputEl.value = '';
  });

  // Clicking outside popup should not close (keep it simple). Escape closes.
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closePopup();
  });

  // init: session id + connect
  (function init(){
    // show session id maybe in console for debugging
    console.debug('WebChat session:', getOrCreateSessionId());
    // connect ws
    connectWebSocket();

    // mobile friendly: tapping FAB opens popup
    // start closed (A) as requested
  })();

  // expose debug helpers
  window.__webchat = {
    open: openPopup,
    close: closePopup,
    send: sendMessage,
    sessionId: getOrCreateSessionId
  };

})();
</script>
</body>
</html>

